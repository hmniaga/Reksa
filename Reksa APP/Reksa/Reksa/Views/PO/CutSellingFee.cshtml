@model Reksa.ViewModels.POListViewModel
@{
    ViewData["Title"] = "Cut Selling Fee";
}
<div class="row">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="m-t-0 header-title">
                <a>Cut Selling Fee</a>
            </h4>
        </div>
        <div class="panel-body">
            <div class="col-md-12">
                <div class="card-box">
                    <!-- Begin Button -->
                    <div>
                        <div class="input-group">
                            <button id=btnProcess class="btn btn-default waves-effect waves-light" style="margin-right:10px">
                                <span class="btn-label">
                                    <i class="fa fa-cogs"></i>
                                </span>
                                Process
                            </button>
                        </div>
                    </div>
                    <!-- End Button -->
                </div>
            </div>
            <div class="col-md-12">
                <div class="card-box">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Start Period</label>
                        <div class="input-group">
                            @(Html.Kendo().DatePicker().Name("dateTimePicker1").HtmlAttributes(new { style = "width: 200px;" }))
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">End Period</label>
                        <div class="input-group">
                            @(Html.Kendo().DatePicker().Name("dateTimePicker2").HtmlAttributes(new { style = "width: 200px;" }))
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Kode Produk</label>
                        <div class="input-group col-md-5">
                            @Html.Kendo().TextBoxFor(model => model.ProductModel.ProdCode).HtmlAttributes(new { @id = "cmpsrProduct_text1", @class = "form-control input-sm" }).Enable(false)
                            <span class="input-group-btn">
                                <a id="cmpsrProduct" href="@Url.Action("SearchProduct", "Global", new { seq = 1, type = "MB" })" data-toggle="modal" data-target="#ProductModal" class="btn btn-default btn-sm btn-search-component src-cif enabled">...</a>
                            </span>
                            @Html.Kendo().TextBoxFor(model => model.ProductModel.ProdName).HtmlAttributes(new { @id = "cmpsrProduct_text2", @class = "form-control input-sm", style = "width: 350px;" }).Enable(false)
                            @Html.Kendo().TextBoxFor(model => model.ProductModel.ProdId).HtmlAttributes(new { @id = "ProdId", @class = "form-control input-sm", @type = "Hidden" })
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="ProductModal" tabindex="-1" role="dialog" aria-labelledby="ProductModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content"></div>
    </div>
</div>
<script>
    var _intProdId;
    $(document).ready(function () {
        var dateTimePicker2 = new Date();
        $("#dateTimePicker2").val(dateTimePicker2.getDate() + '/' + (dateTimePicker2.getMonth() + 1) + '/' + dateTimePicker2.getFullYear());

        $("#btnProcess").click(function () {
            if ($("#cmpsrProduct_text1").val() == "") {
                swal("Warning", "Kode Produk Wajib diisi", "warning");
                return;
            }
            _intProdId = $("#ProdId").val();
            if (_intProdId != 0 && ($("#cmpsrProduct_text2").val() != ""))
            {
                callReksaCutSellingFee();
            }
            else {
                swal("Warning", "Kode Produk Wajib diisi", "warning");
            }
        });
        $("#cmpsrProduct_text1").change(function () {

            var res = ValidateProduct($("#cmpsrProduct_text1").val());
            res.success(function (data) {
                _intProdId = data[0].ProdId;
            });
            var res = callReksaGetLastFeeDate();
            res.success(function (data) {
                if (data.blnResult) {
                    var dateTimePicker1 = new Date(data.dtStartDate);
                    $("#dateTimePicker1").val(dateTimePicker1.getDate() + '/' + (dateTimePicker1.getMonth() + 1) + '/' + dateTimePicker1.getFullYear());
                }
                else {
                    swal("Warning", data.ErrMsg, "warning");
                }
            });
            var dateTimePicker2 = new Date();
            $("#dateTimePicker2").val(dateTimePicker2.getDate() + '/' + (dateTimePicker2.getMonth() + 1) + '/' + dateTimePicker2.getFullYear());
        });  
    });

    function ValidateProduct(ProdCode) {
        return $.ajax({
            type: 'GET',
            url: '/Global/ValidateProduct',
            data: { Col1: ProdCode, Col2: '', Validate: 1 },
            async: false
        });
    } 

    function callReksaCutSellingFee()
    {
        var dtStartDate = $("#dateTimePicker1").val();
        var dtEndDate = $("#dateTimePicker2").val();
        $.ajax({
            type: 'POST',
            url: '/PO/ProcessCutSellingFee',
            data: { StartDate: dtStartDate, EndDate: dtEndDate, ProdId: _intProdId},
            success: function (data) {
                if (data.blnResult)
                {
                    swal("Success", "Proses Cut Selling Fee berhasil", "success");
                    var res = callReksaGetLastFeeDate();
                    res.success(function (data) {
                        if (data.blnResult) {
                            var dateTimePicker1 = new Date(data.dtStartDate);
                            $("#dateTimePicker1").val(dateTimePicker1.getDate() + '/' + (dateTimePicker1.getMonth() + 1) + '/' + dateTimePicker1.getFullYear());
                        }
                        else {
                            swal("Warning", data.ErrMsg, "warning");
                        }
                    });
                    var dateTimePicker2 = new Date();
                    $("#dateTimePicker2").val(dateTimePicker2.getDate() + '/' + (dateTimePicker2.getMonth() + 1) + '/' + dateTimePicker2.getFullYear());
                }
                else
                {
                    swal("Warning", data.ErrMsg, "warning");
                }
            }
        });
    }
    function callReksaGetLastFeeDate()
    {
        return $.ajax({
            type: 'GET',
            url: '/PO/GetLastFeeDate',
            data: { Type: 3, ManId: 1, ProdId: _intProdId },
            async: false
        });
    }
</script>
